# 任务调度模块使用手册

## 介绍

ReactGO 内置任务调度模块，它的工作方式类似于 UNIX 系统的 crontab，并且采用同样的 Cron 表达式。

任务调度模块支持两种类型的任务：
- **函数（Type 1）**：预先编译到 ReactGO 执行文件中的内置函数
- **命令（Type 2）**：系统中的可执行文件或脚本

## 环境配置

### 必需环境变量

- `TASK_PATH`：任务脚本的根目录路径。所有相对路径的命令都会基于此目录查找。

### 自动传递的环境变量

执行命令时，系统会自动传递以下环境变量：
- `DSN`：数据库连接字符串（从 `DB_URL` 环境变量获取）

## 任务类型

### 函数（Type 1）

函数是硬编码到 ReactGO 执行文件中的，它们不灵活，但是效率高，并且可以直接访问 ReactGO 的运行时环境。

**特点：**
- 执行效率高，无需启动外部进程
- 可以直接访问 ReactGO 的运行时环境
- 需要重新编译才能添加新函数

**注册函数：**
函数通过 `task.Funcs` 全局变量注册，每个函数包含：
- `Name`：函数显示名称
- `Path`：函数路径标识符（用于任务配置）
- `Func`：函数实现

**当前可用函数：**
- `test`：测试函数

**使用示例：**
在任务配置中，将 `type` 设置为 `1`，`path` 设置为函数路径（如 `test`）。

### 命令（Type 2）

命令是系统中的可执行文件，可以是任何语言编写的程序（如 shell、Python、Node.js、Ruby 等）。

**特点：**
- 灵活性强，可以使用任何编程语言
- 需要自行准备运行环境（如 Node.js 的 npm 模块、Python 的虚拟环境等）
- 支持命令行参数

**路径规则：**
- **相对路径**：相对于 `TASK_PATH` 环境变量指定的目录
- **绝对路径**：直接使用系统绝对路径

**命令行参数：**
命令路径支持空格分隔的参数，例如：
- `my_script.sh arg1 arg2`
- `/usr/bin/python3 /path/to/script.py --option value`

**可执行权限：**
命令文件必须具有可执行权限（`chmod +x`），否则任务执行会失败。

**使用示例：**
```bash
# 假设 TASK_PATH=/opt/tasks
# 相对路径：my_task.sh
# 绝对路径：/usr/local/bin/my_task.sh
# 带参数：my_task.sh --verbose --output /tmp/result.log
```

## Cron 表达式

任务调度使用标准的 Cron 表达式，支持以下格式：

```
秒 分 时 日 月 星期 [描述符]
```

**支持的格式：**
- 标准格式：`0 0 * * *`（每天 0 点执行）
- 秒可选格式：`*/5 * * * *`（每 5 分钟执行）
- 描述符：`@daily`、`@hourly`、`@weekly` 等

**示例：**
- `0 0 * * *`：每天 0 点执行
- `*/30 * * * *`：每 30 分钟执行
- `0 */2 * * *`：每 2 小时执行
- `0 0 0 * * 0`：每周日 0 点执行
- `@daily`：每天执行一次

## 任务管理

### 任务状态

每个任务有以下状态：
- **启用（disabled = false）**：任务会按照 Cron 表达式自动调度执行
- **禁用（disabled = true）**：任务不会自动调度，但可以手动触发

### 任务属性

- `uuid`：任务唯一标识符
- `name`：任务名称
- `summary`：任务描述
- `cron`：Cron 表达式
- `type`：任务类型（1=函数，2=命令）
- `path`：函数路径或命令路径
- `last_fire`：最后执行时间
- `nfire`：执行次数统计
- `disabled`：是否禁用
- `note`：备注信息

## 任务执行

### 重入控制

ReactGO 的任务调度是**不可重入**的，即：
- 如果任务正在执行中，不会再次调度该任务
- 系统使用 `SkipIfStillRunning` 机制自动跳过正在运行的任务

**例外情况：**
1. 为同一个命令创建了多个调度任务
2. 手动触发任务（会破坏重入规则）

### 手动触发

支持通过管理后台手动触发任务执行：
- 即使任务正在运行，手动触发也会尝试执行
- 如果任务正在执行中，手动触发会返回错误提示
- 手动触发会创建新的任务实例记录

### 执行记录

每次任务执行都会创建一条 `task_inst` 记录，包含：
- `uuid`：实例唯一标识符
- `task_uuid`：关联的任务 UUID
- `task_name`：任务名称
- `task_type`：任务类型
- `code`：执行状态码（0=执行中，200=成功，500=失败）
- `message`：执行输出或错误信息
- `elapsed`：执行耗时（毫秒）

**性能监控：**
- 执行耗时超过 300 毫秒会记录警告日志
- 所有执行记录都会记录到日志中

## API 端点

### 任务管理

- `POST /admin/system/task/create`：创建任务
- `POST /admin/system/task/update`：更新任务
- `POST /admin/system/task/delete/:id`：删除任务（需要验证码）
- `GET /admin/system/task/search`：搜索任务列表
- `GET /admin/system/task/find/:id`：查找任务详情

### 任务控制

- `POST /admin/system/task/fire/:primary`：立即执行任务
- `POST /admin/system/task/disable/:primary`：禁用/启用任务

### 任务查询

- `GET /admin/system/task/funcs`：查询可用函数列表
- `GET /admin/system/task/entries`：查询正在运行的任务列表
  - 返回信息包括：UUID、名称、Cron 表达式、路径、运行状态、下次执行时间、上次执行时间

### 任务历史

- `POST /admin/system/task/inst/clean`：清理任务历史记录
  - 支持按状态码过滤（`code` 参数）
  - 默认清理 7 天前的记录

## 环境变量配置

### 为命令设置环境变量

你可以为命令设置自定义环境变量，这是传递参数的一种方式。

**使用场景：**
- 外部服务认证信息（账号/密码）
- API 密钥
- 配置文件路径
- 其他运行时参数

**配置方式：**
环境变量通过 `scheduler.taskEnv` 配置，键名会自动转换为大写。

**自动传递的环境变量：**
- `DSN`：数据库连接字符串（从 `DB_URL` 获取）

## 启动和停止

### 启动任务调度

系统启动时会自动调用 `task.Startup()`：
1. 检查 `TASK_PATH` 环境变量
2. 验证任务路径目录是否存在
3. 查询所有未禁用的任务（`disabled = false`）
4. 逐个添加任务到调度器
5. 启动 Cron 调度器

### 停止任务调度

系统关闭时会调用 `task.Stop()` 停止所有任务调度。

## 注意事项

1. **任务路径**：确保 `TASK_PATH` 环境变量正确配置，且目录存在
2. **可执行权限**：命令文件必须具有可执行权限
3. **重入控制**：避免为同一任务创建多个调度，除非确实需要并发执行
4. **执行时间**：长时间运行的任务可能影响系统性能，建议优化任务执行时间
5. **错误处理**：命令执行失败会记录到任务实例中，建议定期检查任务执行历史
6. **历史清理**：定期清理任务历史记录，避免数据库表过大