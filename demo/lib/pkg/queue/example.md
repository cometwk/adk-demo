
## 集成测试方案简述

该测试是一个端到端集成测试，验证队列系统的完整流程。

### 测试架构

```
TestExample (测试函数)
    ↓
创建带超时的 Context (20秒)
    ↓
在 goroutine 中运行 RunExample
    ↓
RunExample 启动完整队列系统
    ├── Producer (生产者)
    ├── Consumer (消费者: 2个Worker，每个3个并发)
    └── StatsMonitor (统计监控)
    ↓
运行 20 秒后自动停止
    ↓
验证优雅关闭和统计信息
```

### 测试流程

1. 初始化阶段（`NewQueueExample`）
   - 连接数据库
   - 清理测试数据（`job_queue`、`job_history`）
   - 创建队列客户端

2. 启动阶段（`RunExample`）
   - Producer：每 2 秒生成任务（最多 1000 次）
     - email：邮件任务（优先级 10）
     - image：图片处理（优先级 5）
     - report：报告生成（优先级 15）
     - slow：慢任务（10秒，优先级 1）
     - error：模拟错误任务（优先级 20）
   - Consumer：2 个 Worker，每个 Worker 3 个并发
     - 监听队列：`high`、`default`、`low`
     - 每 100ms 尝试出队
     - 处理任务并更新状态
   - StatsMonitor：每 10 秒打印统计信息

3. 运行阶段（20秒）
   - Producer 持续生产任务
   - Consumer 持续消费并处理
   - 验证优先级队列、任务重试、错误处理等

4. 停止阶段（Context 取消）
   - Context 超时触发取消
   - `RunExample` 检测到取消信号
   - 调用 `Stop()` 优雅关闭
   - 等待所有 goroutine 完成（`wg.Wait()`）
   - 打印最终统计信息

### 测试要点

1. 超时控制：使用 `context.WithTimeout` 避免测试无限等待
2. 并发安全：通过 `sync.WaitGroup` 确保所有 goroutine 正确退出
3. 端到端验证：覆盖从生产、入队、出队、处理到完成的流程
4. 真实场景：模拟多种任务类型和优先级
5. 优雅关闭：验证系统能正确停止并清理资源

该测试验证了队列系统的完整功能，包括任务生产、消费、处理、错误处理和优雅关闭等核心能力。

### 输出示例
```
2025/11/04 16:55:33 📊 ===== 队列统计信息 =====
2025/11/04 16:55:33 📦 队列 high: 1 个任务
2025/11/04 16:55:33 📦 队列 default: 0 个任务
2025/11/04 16:55:33 📦 队列 low: 2 个任务
2025/11/04 16:55:33 📈 总任务数: 3
2025/11/04 16:55:33 🔒 锁定任务数: 3
2025/11/04 16:55:33 ✅ 完成任务数: 26
2025/11/04 16:55:33 💀 死信任务数: 0
2025/11/04 16:55:33 📊 ========================
2025/11/04 16:55:33 🎭 队列演示结束
```
