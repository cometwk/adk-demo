# 支付平台业务说明报告

## 1. 代理关系

### 1.1 设计

#### 1.1.1 角色定义
- **代理商 (agent)**: 分润体系的核心角色，负责拓展商户或通道的中间人/渠道商
- **商户 (merch)**: 接入支付平台的商家，发起支付请求
- **机构商户 (chan_merch)**: 商户在具体支付通道侧的身份映射，桥接商户与通道
- **通道 (chan)**: 底层支付渠道/机构（如微信支付、支付宝、银联等）

#### 1.1.2 关系模型
- **多态关系表**: `agent_rel` 表通过 `agent_type` 字段区分代理类型
  - `agent_type = 'MERCH'`: 代理商代理商户，`obj_no = merch.merch_no`
  - `agent_type = 'CHAN'`: 代理商代理通道，`obj_no = chan.chan_no`
- **唯一约束**: `UK(agent_no, obj_no)` 保证同一代理商对同一对象只有一条关系
- **多对多关系**: 一个对象可以绑定多个代理商，形成 n:n 关系

#### 1.1.3 费率体系
- **费率单位**: 所有费率以十万分比 (basis = 100,000) 存储
- **费率公式**: `通道费率 - 商户费率 - Σ(通道代理费率) - Σ(商户代理费率) >= 0`
- **剩余费率**: 公式结果为平台利润，必须 >= 0

### 1.2 业务规则

#### 1.2.1 绑定规则
- **唯一性**: 同一代理商对同一对象只能有一条关系，重复绑定会被拒绝
- **多态绑定**: 必须通过 `agent_type` 正确区分代理类型
- **费率范围**: 费率必须在 [0, 100000] 范围内（0% ~ 100%）

#### 1.2.2 费率校验规则
- **平台保底**: 费率修改不得导致平台亏损（剩余费率 >= 0）
- **完整校验**: 需要组装完整的 RateInfo（通道 + 商户 + 通道代理列表 + 商户代理列表）
- **特殊情况**: 无活跃 chan_merch 时跳过校验（无交易链路）

#### 1.2.3 操作规则
- **统一接口**: 通过 `action` 参数区分操作类型
  - `action = 'bound'`: 创建代理关系
  - `action = 'unbound'`: 删除代理关系  
  - `action = 'rate'`: 更新费率
- **数据一致性**: 冗余字段 `agent_id`、`obj_id`、`obj_name` 需与源表保持同步

### 1.3 如何操作

#### 1.3.1 代理商管理
- **创建代理商**: 通过 `/admin/agent/create` 接口创建新代理商
- **查询代理商**: 通过 `/admin/agent/detail` 查询代理商详情及关联的商户/通道列表

#### 1.3.2 代理关系绑定
- **商户代理绑定**: 
  - 接口: `/admin/merch/agent/bind-agent`
  - 参数: `merch_id`, `agent_id`, `action`, `rate`
- **通道代理绑定**: 
  - 接口: `/admin/channel/agent/bind-agent`
  - 参数: `chan_id`, `agent_id`, `action`, `rate`

#### 1.3.3 代理关系查询
- **已绑定查询**: 
  - 参数: `bound=true`, `merch_id` 或 `chan_id`
  - 返回: 已绑定的代理商列表，包含费率信息
- **未绑定查询**: 
  - 参数: `bound=false`, `merch_id` 或 `chan_id`
  - 返回: 未绑定的代理商列表

## 2. 支付

### 2.1 设计

#### 2.1.1 四方聚合支付模式
- **用户 (User)**: 支付方
- **商户 (Merchant)**: 收款方，包含前端和后台
- **聚合支付 (Aggregator)**: 提供统一API接口，聚合多种支付渠道
- **支付通道 (Channel)**: 持有支付牌照的机构，处理资金清算

#### 2.1.2 支付方式设计
- **JSAPI支付**: 适用于微信/支付宝内部H5页面
- **Native扫码支付**: 适用于PC网站，用户扫描二维码
- **H5支付**: 适用于手机浏览器，自动拉起支付App
- **APP支付**: 适用于原生App，集成支付SDK
- **付款码支付**: 适用于线下实体店，商户扫描用户付款码

### 2.2 业务规则

#### 2.2.1 金额处理规则
- **线上支付**: 金额由商户系统预先计算，用户只能确认
- **线下支付**: 金额由商户收银员在POS机上输入

#### 2.2.2 状态确认规则
- **同步回调**: JSAPI、APP、付款码支付提供同步回调
- **异步通知**: 所有支付方式都提供异步通知（最准确的支付凭证）
- **主动查询**: 前端收到回调后必须主动查询确认最终支付结果

#### 2.2.3 安全规则
- **防伪造**: 不依赖单一回调，必须结合异步通知和主动查询
- **轮询机制**: 对于可能需要用户输入密码的场景，启动轮询查询

### 2.3 如何操作

#### 2.3.1 支付流程
1. **商户发起**: 商户前端向商户后台提交订单
2. **创建订单**: 商户后台调用聚合支付接口创建订单
3. **通道下单**: 聚合支付调用支付通道统一下单接口
4. **返回参数**: 通道返回支付参数给聚合支付
5. **传递参数**: 聚合支付将参数返回给商户后台
6. **前端调起**: 商户前端调用支付SDK/JS-SDK
7. **用户支付**: 用户在支付界面确认并输入密码
8. **状态确认**: 通过同步回调 + 异步通知 + 主动查询确认支付结果

#### 2.3.2 API调用
- **创建订单**: POST `/api/pay/create`
- **查询订单**: GET `/api/pay/query`
- **退款申请**: POST `/api/pay/refund`

## 3. 分润

### 3.1 设计

#### 3.1.1 分润目标
- **T+1结算**: 在100～500万/日交易量下实现T+1分润
- **可补偿**: 支持重算和补偿
- **可对账**: 提供完整的对账数据
- **不影响主链路**: 分润计算在闲时进行，不影响交易主流程

#### 3.1.2 数据结构
- **分润表 (profit_daily)**: 按日统计每个代理商的分润
  - 唯一键: `(stat_date, agent_type, agent_no)`
  - 状态机: `0=未结算, 1=审批中, 2=已审批/已结算`
- **结算表 (profit_settle)**: 记录代理商的结算申请和审批状态

#### 3.1.3 计算流程
1. **生成结算目标**: 从 `agent_rel` 获取全部结算目标
2. **聚合事实表**: 
   - 订单聚合: 从 `orders` 按 `stat_date` 聚合
   - 退款聚合: 以 `refund_time` 的本地日作为退款归属日
3. **计算分润**: 
   - `total_profit = total_trade_amt * rate / 100000`
   - `total_refund_deduct = total_refund_amt * rate / 100000`
   - `net_profit = total_profit - total_refund_deduct`
4. **写入分润表**: 按唯一键 upsert 到 `profit_daily`

### 3.2 业务规则

#### 3.2.1 分润计算规则
- **费率应用**: 分润金额 = 交易金额 × 费率 / 100000
- **退款处理**: 退款金额需扣除相应分润
- **净分润**: 净分润 = 总分润 - 退款扣除分润

#### 3.2.2 数据来源规则
- **实时数据**: 从 `orders` 和 `refunds` 表直接聚合
- **导入数据**: 从 `order_daily` 表聚合，不处理退款
- **幂等性**: 支持删除当日记录后重算

#### 3.2.3 状态管理规则
- **默认状态**: 新创建的分润记录状态为 `0`（未结算）
- **状态流转**: `0 -> 1 -> 2` 由Admin UI/流程控制
- **总分关联**: 结算记录创建时，要求 `profit_daily.profit_settle_id = profit_settle.id`

### 3.3 如何操作

#### 3.3.1 分润计算
- **定时任务**: 系统自动执行T+1分润计算
- **手动重算**: 通过 `RecalcProfitDaily` 重新计算指定日期的分润
- **导入分润**: 通过 `IngestProfitDaily` 基于导入数据计算分润

#### 3.3.2 分润查询
- **分润统计**: GET `/a/stats/profit-by-status` - 按状态统计分润
- **分润查询**: GET `/a/profit/search` - 分页查询分润记录
- **商户汇总**: GET `/a/stats/merch-summary` - 商户分润汇总
- **商户统计**: GET `/a/stats/merch-stats` - 商户详细分润统计

#### 3.3.3 分润申请
- **结算申请**: POST `/a/profit/settle/apply` - 提交结算申请
- **审批结算**: POST `/a/profit/settle/:id/approve` - 审批结算申请

## 4. 结算

### 4.1 设计

#### 4.1.1 结算流程
1. **分润生成**: T+1生成分润记录（`profit_daily`）
2. **结算申请**: 代理商按时间范围提交结算申请
3. **结算记录**: 创建结算记录（`profit_settle`）
4. **审核流程**: 执行结算审核
5. **状态更新**: 更新分润记录的结算状态

#### 4.1.2 结算周期
- **默认周期**: 按月结算
- **灵活选择**: 理论上支持自定义时间段
- **批量处理**: 支持按代理商、时间段批量结算

### 4.2 业务规则

#### 4.2.1 结算条件
- **分润状态**: 只能对状态为 `0`（未结算）的分润记录申请结算
- **时间范围**: 结算申请必须指定有效的时间范围
- **代理商过滤**: 所有结算操作都按代理商过滤

#### 4.2.2 审核规则
- **审批流程**: 结算申请需要经过审核才能完成
- **状态同步**: 审核通过后，相关分润记录状态更新为 `2`
- **数据一致性**: 确保分润明细与结算汇总的一致性

#### 4.2.3 异常处理
- **重复申请**: 同一时间段不能重复申请结算
- **部分失败**: 支持部分成功部分失败的处理
- **回滚机制**: 审核失败时能够回滚相关状态

### 4.3 如何操作

#### 4.3.1 结算申请
- **选择时间范围**: 代理商选择要结算的时间段（目前按月）
- **提交申请**: 调用结算申请接口创建结算记录
- **查看状态**: 查询结算申请的状态

#### 4.3.2 结算审核
- **审核列表**: 查看待审核的结算申请
- **审核操作**: 执行审核通过或拒绝操作
- **状态跟踪**: 跟踪结算申请的完整状态流转

#### 4.3.3 结算查询
- **结算记录查询**: GET `/a/profit/settle/search` - 分页查询结算记录
- **结算状态统计**: 统计不同状态的结算记录数量
- **历史结算查询**: 查询历史结算记录

## 5. 订单导入

### 5.1 设计

#### 5.1.1 导入流程
1. **创建通道**: 基于商户签约机构号创建通道
2. **导入商户**: 导入子商户查询记录，创建平台商户和机构商户
3. **人工绑定**: 人工绑定代理关系
4. **导入订单**: 导入结算查询的XLS记录

#### 5.1.2 数据标记
- **平台商户**: `merch.remark = 'ingest'`
- **机构商户**: `chan_merch.chan_type = 'ingest'`
- **通道**: `chan.chan_type = 'ingest'`

#### 5.1.3 数据结构
- **商户日报表 (order_daily)**: 存储导入的商户日报数据
  - 维度: `report_date`, `merch_no`, `chan_no`
  - 指标: `total_count`, `total_amount`

### 5.2 业务规则

#### 5.2.1 导入规则
- **数据完整性**: 导入数据必须包含完整的商户和通道信息
- **唯一性**: 同一日期同一商户的数据不能重复导入
- **格式要求**: XLS文件必须符合指定的格式要求

#### 5.2.2 分润计算规则
- **无退款处理**: 导入数据的分润计算不处理退款
- **费率应用**: 与实时数据使用相同的费率计算逻辑
- **数据隔离**: 导入数据与实时数据在分润计算中保持隔离

#### 5.2.3 异常处理
- **数据校验**: 导入前进行数据格式和完整性校验
- **错误回滚**: 导入失败时能够回滚已导入的数据
- **重试机制**: 支持失败后的重试导入

### 5.3 如何操作

#### 5.3.1 导入准备
- **通道管理**: 预先创建通道（`/admin/chan/create`）
- **商户管理**: 导入商户（`/admin/merch/import`）
- **关系绑定**: 人工绑定代理关系

#### 5.3.2 订单导入
- **文件上传**: 上传XLS订单文件
- **数据解析**: 系统解析XLS文件内容
- **数据验证**: 验证数据格式和完整性
- **数据入库**: 将验证通过的数据写入 `order_daily` 表

#### 5.3.3 分润计算
- **触发计算**: 导入完成后触发分润计算
- **结果查看**: 在分润管理界面检查分润数据
- **异常处理**: 处理分润计算中的异常情况

## 总结

本支付平台采用四方聚合支付模式，通过代理关系实现灵活的分润体系。系统设计遵循以下原则：

1. **安全性**: 通过多重验证确保支付和分润的安全性
2. **一致性**: 通过事务和唯一约束保证数据一致性  
3. **可扩展性**: 支持多种支付方式和灵活的代理关系
4. **可维护性**: 提供完整的对账和异常处理机制
5. **性能**: 在高并发场景下保证系统稳定性和响应速度

各模块之间通过清晰的接口和数据流进行协作，形成了完整的支付-分润-结算业务闭环。