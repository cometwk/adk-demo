# 支付平台业务需求文档

## 1. 系统概述

本支付平台是一个四方聚合支付系统，支持多种支付方式、商户进件、代理分润和结算功能。系统核心角色包括：

- **用户 (User)**: 支付方
- **商户 (Merchant)**: 收款方，包含其前端和后台
- **聚合支付 (Aggregator)**: 提供统一API接口，聚合多种支付渠道
- **支付通道 (Channel)**: 持有支付牌照的机构（如微信、支付宝、银联等）

## 2. 核心业务模块

### 2.1 支付模块

#### 支持的支付方式

1. **JSAPI支付 (公众号/小程序支付)**
   - 适用于微信/支付宝内部H5页面
   - 依赖JS-SDK调起支付
   - 同步回调 + 异步通知双重确认

2. **Native扫码支付 (PC网站扫码)**
   - 适用于PC网站
   - 用户用手机扫描PC端二维码完成支付
   - 轮询机制查询支付状态

3. **H5支付 (手机浏览器支付)**
   - 适用于手机浏览器
   - 自动拉起微信/支付宝App
   - 支付完成后跳回浏览器

4. **APP支付 (原生App内支付)**
   - 适用于商户原生App
   - 集成原生支付SDK
   - SDK回调 + 异步通知双重确认

5. **付款码支付 (线下扫码)**
   - 适用于线下实体店
   - 商户主动扫描用户付款码
   - 同步响应 + 轮询机制

### 2.2 商户进件模块

#### 进件流程
1. 商户提交进件申请
2. 系统验证商户信息
3. 创建商户和通道关系
4. 审核通过后激活商户

#### 核心数据结构
- **商户表 (merch)**: 存储商户基本信息、费率、联系方式
- **通道表 (chan)**: 存储支付通道信息、费率
- **机构商户表 (chan_merch)**: 桥接商户与通道的关系

#### 进件必填信息
- 商户类别码 (MCC码)
- 商户中文/英文名称
- 统一社会信用代码
- 法人信息及证件
- 联系人信息
- 经营场所地址
- 结算账户信息
- 支付通道费率配置

### 2.3 代理分润模块

#### 代理关系模型
- **代理商 (agent)**: 分润体系核心角色
- **代理关系表 (agent_rel)**: 多态关系表，支持代理商户或通道
  - `agent_type = 'MERCH'`: 代理商户
  - `agent_type = 'CHAN'`: 代理通道
- **费率体系**: 所有费率以十万分比存储 (basis = 100,000)

#### 分润计算规则
```
平台利润 = 通道费率 - 商户费率 - Σ(通道代理费率) - Σ(商户代理费率) >= 0
```

#### 分润数据表
- **日分润统计表 (profit_daily)**: 按日统计每个代理商的分润
- **结算表 (profit_settle)**: 记录代理商的结算申请和审批状态

### 2.4 订单导入模块

#### 导入流程
1. 创建通道（基于商户签约机构号）
2. 导入子商户查询记录
3. 人工绑定代理关系
4. 导入结算查询记录（XLS文件）

#### 数据标记
- 平台商户: `merch.remark = 'ingest'`
- 机构商户: `chan_merch.chan_type = 'ingest'`
- 通道: `chan.chan_type = 'ingest'`

## 3. 业务规则

### 3.1 代理关系规则

1. **唯一性约束**: 同一代理商对同一对象只能有一条关系 (`UK(agent_no, obj_no)`)
2. **多态绑定**: 通过`agent_type`区分代理类型，`obj_no`指向被代理对象
3. **多对多关系**: 一个对象可以绑定多个代理商
4. **费率范围**: 费率必须在[0, 100000]范围内（0% ~ 100%）
5. **平台保底**: 费率修改不得导致平台亏损（剩余费率 >= 0）

### 3.2 费率校验规则

#### 商户侧绑定代理校验
- 组装完整的RateInfo（通道 + 商户 + 通道代理列表 + 商户代理列表）
- 校验: `通道费率 - 商户费率 - Σ(全部关联代理费率) >= 0`

#### 通道侧绑定代理校验
- 对通道下所有关联商户分别进行费率校验
- 任一商户不满足条件即拒绝操作

#### 特殊情况处理
- 无活跃chan_merch时跳过校验（无交易链路）

### 3.3 分润计算规则

#### 日分润计算 (T+1)
- **输入**: `stat_date`（业务日期，本地日）
- **输出**: 对每个`(stat_date, agent_type, agent_no)`写入一行`profit_daily`

#### 计算步骤
1. **生成结算目标**: 从`agent_rel`获取全部结算目标
2. **直接聚合事实表**: 
   - 订单聚合: 从`orders`按`stat_date`聚合
   - 退款聚合: 以`refund_time`的本地日作为退款归属日
3. **计算分润**:
   - `total_profit = total_trade_amt * rate / 100000`
   - `total_refund_deduct = total_refund_amt * rate / 100000`
   - `net_profit = total_profit - total_refund_deduct`
4. **写入profit_daily**: 以唯一键`(stat_date, agent_type, agent_no)` upsert

#### 导入数据分润计算
- 基于`order_daily`表计算分润
- 不处理退款（退款相关字段固定为0）
- 适用于无法直接聚合`orders`的场景

### 3.4 结算规则

#### 结算状态机
- `0 = 未结算`
- `1 = 审批中`
- `2 = 已审批/已结算`

#### 结算流程
1. 代理商浏览自己的`profit_daily`列表
2. 按时间范围（目前按月）提交结算申请
3. 创建`profit_settle`记录
4. 执行审核流程
5. 审核通过后更新`profit_daily.profit_settle_id`

### 3.5 数据一致性规则

#### 总分关联
- 结算记录创建时，要求`profit_daily.profit_settle_id = profit_settle.id`
- 确保分润明细与结算汇总的一致性

#### 幂等性
- 导入分润计算支持幂等重算（先删除当日记录后重算）

## 4. API接口规范

### 4.1 代理商相关API

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/a/profit/search` | profit_daily分页查询（支持日期范围） |
| GET | `/a/profit/settle/search` | profit_settle分页查询 |
| GET | `/a/stats/profit-by-status` | 分润统计（按结算状态） |
| GET | `/a/stats/merch-list` | 当前代理商绑定的商户列表 |
| GET | `/a/stats/merch-summary` | 商户汇总统计 |
| GET | `/a/stats/merch-stats` | 商户详细统计（按日/月） |
| POST | `/a/profit/settle/:id/approve` | 审批结算 |
| POST | `/a/profit/settle/apply` | 结算申请 |

### 4.2 进件相关API

- **admin端**: 服务商管理、进件进度查看
- **biz-admin端**: 进件管理（新增、查询）
- **saas-api**: 商户自助进件接口

## 5. 系统限制

1. **无代理层级**: `agent_rel`为扁平的一层关系，不支持多级代理
2. **冗余字段**: `agent_id`、`obj_id`、`obj_name`为冗余存储，需与源表保持同步
3. **结算周期**: 目前仅支持按月结算，未来可扩展自定义时间段
4. **性能目标**: 在100～500万/日交易量下，实现T+1结算

## 6. 未来扩展方向

1. **多级代理支持**: 实现上级代理→下级代理→商户的层级关系
2. **实时分润**: 从T+1结算向实时分润演进
3. **智能费率**: 基于风险评估的动态费率调整
4. **国际化支持**: 多币种、多语言、跨境支付
5. **风控集成**: 深度集成反欺诈和风险控制能力